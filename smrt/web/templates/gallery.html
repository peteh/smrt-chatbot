<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery - {{ gallery_uuid }}</title>
  <style>
    :root{
      --gap:12px;
      --thumb-h:180px;
      --bg:#111;
      --card:#1b1b1b;
      --accent:#6ab0ff;
      --muted:#9aa6b2;
    }
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#eee}
    .wrap{max-width:1200px;margin:20px auto;padding:16px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    header h1{font-size:1.1rem;margin:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:var(--gap)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:8px;padding:8px;display:flex;flex-direction:column;align-items:stretch;overflow:hidden}
    .thumb{height:var(--thumb-h);object-fit:cover;width:100%;border-radius:6px;cursor:pointer;display:block}
    .meta{display:flex;justify-content:space-between;align-items:center;padding-top:8px;font-size:0.85rem;color:var(--muted)}
    .meta .sender{font-weight:600;color:#fff}
    .empty{padding:40px;background:rgba(255,255,255,0.02);border-radius:8px;text-align:center;color:var(--muted)}
    /* lightbox */
    .lightbox{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:1000;padding:20px}
    .lightbox.active{display:flex}
    .lightbox-content{max-width:calc(100% - 40px);max-height:calc(100% - 80px);display:flex;flex-direction:column;align-items:center}
    .lightbox img{max-width:100%;max-height:80vh;border-radius:6px;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
    .lightbox .caption{margin-top:8px;color:var(--muted);font-size:0.95rem}
    .lightbox .close, .lightbox .nav{position:absolute;top:18px;color:#fff;background:rgba(0,0,0,0.25);border:0;padding:8px;border-radius:6px;cursor:pointer}
    .lightbox .close{right:18px}
    .download-link{margin-left:12px;color:var(--accent);background:transparent;border:0;padding:6px 10px;border-radius:6px;text-decoration:none;font-weight:600}
    .lightbox .nav{top:50%;transform:translateY(-50%);padding:12px}
    .lightbox .prev{left:18px}
    .lightbox .next{right:18px}
    @media (max-width:520px){:root{--thumb-h:120px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gallery</h1>
      <!--<div style="margin-left:auto;color:var(--muted)">id: <code style="color:#fff;margin-left:8px">{{ gallery_uuid }}</code></div>-->
      <a id="downloadGallery" class="download-link" href="#" title="Download gallery as ZIP">⬇ Download ZIP</a>
    </header>

    <div id="galleryContainer" class="grid" aria-live="polite">
      <div class="empty">Loading...</div>
    </div>
  </div>

  <div id="lightbox" class="lightbox" role="dialog" aria-hidden="true">
    <button class="close" id="lbClose" title="Close">✕</button>
    <button class="nav prev" id="lbPrev" title="Previous">◀</button>
    <div class="lightbox-content">
      <img id="lbImage" src="" alt="">
      <div class="caption" id="lbCaption"></div>
    </div>
    <button class="nav next" id="lbNext" title="Next">▶</button>
  </div>

  <script>
    (function(){
      const galleryId = "{{ gallery_uuid }}";
      const apiList = `/api/v1/images/${encodeURIComponent(galleryId)}`;
      // set gallery download link (encoded)
      const dlElem = document.getElementById('downloadGallery');
      if (dlElem) {
        dlElem.href = `/api/v1/download/${encodeURIComponent(galleryId)}/gallery.zip`;
        dlElem.setAttribute('download', `${galleryId}-gallery.zip`);
      }
      const gallery = document.getElementById('galleryContainer');
      let images = [];
      let currentIndex = -1;

      function thumbUrl(img){
        // thumbnails served as PNG by the API - adjust if your endpoint differs
        return `/api/v1/thumb/${encodeURIComponent(galleryId)}/${encodeURIComponent(img.image_uuid)}.png`;
      }
      function fullUrl(img){
        return `/api/v1/image/${encodeURIComponent(galleryId)}/${encodeURIComponent(img.image_uuid)}/${encodeURIComponent(img.image_name)}`;
      }

      function renderEmpty(text){
        gallery.innerHTML = `<div class="empty">${text}</div>`;
      }

      function buildCard(img, idx){
        const card = document.createElement('div');
        card.className = 'card';
        const imgEl = document.createElement('img');
        imgEl.className = 'thumb';
        imgEl.alt = `${img.image_name} — ${img.sender}`;
        imgEl.dataset.index = idx;
        imgEl.src = thumbUrl(img);
        imgEl.loading = 'lazy';
        imgEl.addEventListener('click', onThumbClick);
        card.appendChild(imgEl);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const sender = document.createElement('div');
        sender.className = 'sender';
        sender.textContent = img.sender || 'unknown';
        const time = document.createElement('div');
        time.className = 'time';
        try{
          const d = new Date(img.time * 1000);
          time.textContent = d.toLocaleString();
        }catch(e){ time.textContent = '' }
        meta.appendChild(sender);
        meta.appendChild(time);
        card.appendChild(meta);
        return card;
      }

      function populate(){
        gallery.innerHTML = '';
        if(!images || images.length === 0){
          renderEmpty('No images found');
          return;
        }
        const frag = document.createDocumentFragment();
        images.forEach((img, idx)=>{
          frag.appendChild(buildCard(img, idx));
        });
        gallery.appendChild(frag);
      }

      async function load(){
        try{
          const res = await fetch(apiList, {cache:'no-store'});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          images = await res.json();
          populate();
        }catch(err){
          console.error('Failed to load images', err);
          renderEmpty('Failed to load images');
        }
      }

      // Lightbox
      const lb = document.getElementById('lightbox');
      const lbImage = document.getElementById('lbImage');
      const lbCaption = document.getElementById('lbCaption');
      const lbClose = document.getElementById('lbClose');
      const lbPrev = document.getElementById('lbPrev');
      const lbNext = document.getElementById('lbNext');

      function openLightbox(idx){
        if(idx < 0 || idx >= images.length) return;
        currentIndex = idx;
        const img = images[idx];
        lbImage.src = fullUrl(img);
        lbImage.alt = img.image_name;
        lbCaption.textContent = `${img.image_name} — ${img.sender || 'unknown'}`;
        lb.classList.add('active');
        lb.setAttribute('aria-hidden','false');
      }
      function closeLightbox(){
        lb.classList.remove('active');
        lb.setAttribute('aria-hidden','true');
        lbImage.src = '';
        currentIndex = -1;
      }
      function prev(){
        if(currentIndex <= 0) return;
        openLightbox(currentIndex - 1);
      }
      function next(){
        if(currentIndex >= images.length - 1) return;
        openLightbox(currentIndex + 1);
      }

      function onThumbClick(ev){
        const idx = Number(ev.currentTarget.dataset.index);
        openLightbox(idx);
      }

      // events
      lbClose.addEventListener('click', closeLightbox);
      lbPrev.addEventListener('click', prev);
      lbNext.addEventListener('click', next);
      lb.addEventListener('click', function(e){
        if(e.target === lb) closeLightbox();
      });
      document.addEventListener('keydown', function(e){
        if(lb.classList.contains('active')){
          if(e.key === 'Escape') closeLightbox();
          if(e.key === 'ArrowLeft') prev();
          if(e.key === 'ArrowRight') next();
        }
      });

      // initial load
      load();
    })();
  </script>
</body>
</html>